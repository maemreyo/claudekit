Váº¥n Ä‘á»:
 Hiá»‡n táº¡i, má»—i khi tÃ´i cháº¡y `/cook plan.md` thÃ¬ nÃ³ sáº½ pháº£i Ä‘á»c láº¡i plan 1 láº§n, máº·c dÃ¹ nÃ³ vá»«a cháº¡y vÃ  test xong 1 task trÆ°á»›c Ä‘Ã³ á»Ÿ main context cá»§a claude code. Liá»‡u cÃ³ thá»ƒ á»Ÿ phase Ä‘áº§u tiÃªn, cÃ³ thá»ƒ lÃ m gÃ¬ Ä‘á»ƒ Ä‘á»¡ pháº£i discovery láº¡i? Discovery ráº¥t á»•n khi tÃ´i cháº¡y á»Ÿ 1 conversation má»›i hoÃ n toÃ n. nhÆ°ng khi cháº¡y liÃªn tá»¥c `/cook plan.md` thÃ¬ dÆ°á»ng nhÆ° pháº£i discovery liÃªn tá»¥c láº¡i thÃ¬ khÃ´ng hay láº¯m.

========================
TÃ´i hiá»ƒu váº¥n Ä‘á»! Khi cháº¡y liÃªn tá»¥c `/cook` trong cÃ¹ng conversation, viá»‡c discovery láº¡i toÃ n bá»™ plan má»—i láº§n thá»±c sá»± khÃ´ng cáº§n thiáº¿t vÃ  tá»‘n thá»i gian. ÄÃ¢y lÃ  má»™t sá»‘ giáº£i phÃ¡p:

## **Giáº£i phÃ¡p Ä‘Æ°á»£c Ä‘á» xuáº¥t: Quick Resume Mode**

ThÃªm logic vÃ o **Phase 1: Discovery** Ä‘á»ƒ phÃ¡t hiá»‡n vÃ  tÃ¡i sá»­ dá»¥ng context:

```markdown
### Phase 1: Discovery (2-5 min â†’ 10-30 seconds if cached)

Task Scanner

GOAL: Find next task to execute

**QUICK RESUME CHECK** (NEW):

1. Check conversation context for recent plan data:
   - Look back last 3 messages for plan parse results
   - Verify same plan file: `$ARGUMENTS`
   - Check file modification time (mtime)
   
2. {{ if plan cached AND file unchanged }}
   âœ… **QUICK RESUME MODE**
   
   Found cached plan from {{ X }} messages ago:
   - Plan: {{ plan file }}
   - Last modified: {{ mtime }} (unchanged)
   - Tasks parsed: {{ count }}
   - Last executed: {{ last task ID }}
   
   ğŸ“‹ Using cached plan structure...
   â© Skipping full re-scan (saves ~2-4 min)
   
   {{ Jump to step 3: Find next uncompleted task }}
   
{{ else }}
   ğŸ” **FULL DISCOVERY MODE**
   
   Reason: {{ new conversation | different file | file modified | no cache }}
   
   {{ Continue with steps 1-2 below }}
{{ endif }}

STEPS (if FULL DISCOVERY):

1. Read plan file: $ARGUMENTS
   {{ store mtime for cache validation }}

2. Parse markdown for tasks:
   ...
   {{ cache parsed structure in conversation memory }}
```

## **CÃ¡ch implement:**

### **Option A: Lightweight Context Check** (Ä‘á» xuáº¥t)

```markdown
### Quick Resume Implementation

At start of Phase 1, add:

```bash
# Check if we just ran this plan
LAST_PLAN_CONTEXT=$(grep -A 50 "COOK COMPLETE" <<< "$CONVERSATION_HISTORY" | head -1)

if [[ "$LAST_PLAN_CONTEXT" =~ "$ARGUMENTS" ]]; then
  FILE_MTIME=$(stat -f %m "$ARGUMENTS" 2>/dev/null || stat -c %Y "$ARGUMENTS")
  
  # If file unchanged in last 5 minutes
  CURRENT_TIME=$(date +%s)
  TIME_DIFF=$((CURRENT_TIME - FILE_MTIME))
  
  if [ $TIME_DIFF -gt 300 ]; then
    echo "âš¡ QUICK RESUME: Using cached plan structure"
    SKIP_FULL_PARSE=true
  fi
fi
```

**Benefits:**
- Saves 2-4 minutes per `/cook` iteration
- Still validates file hasn't changed
- No external state files needed
- Uses existing conversation context

---

### **Option B: Optimized Re-scan** (alternative)

Thay vÃ¬ skip hoÃ n toÃ n, lÃ m "incremental discovery":

```markdown
### Incremental Discovery

1. {{ if recently parsed }}
   - Read ONLY the checkbox states (lightweight)
   - Skip parsing task details (already in context)
   - Find first `[ ]` in cached task list
   
2. {{ if task details needed }}
   - Retrieve from conversation context
   - Or quick re-read of specific task section only
```

**Benefits:**
- Always fresh checkbox states
- But reuses parsed task metadata
- Safer than full cache

---

## **Recommended Approach:**

TÃ´i suggest **hybrid approach**:

```markdown
### Phase 1: Smart Discovery

STEP 1: Context Check (10 seconds)

{{ if same conversation AND file unchanged }}
  MODE: QUICK RESUME
  - Reuse parsed task structure âœ“
  - Re-read ONLY checkbox lines âœ“
  - Time saved: ~90%
{{ else }}
  MODE: FULL DISCOVERY  
  - Complete plan parsing
  - Cache results for next run
{{ endif }}
```

### **Cá»¥ thá»ƒ trong /cook:**

```markdown
1. Discovery Optimization:

{{ at start of Phase 1 }}

# Quick context probe
if conversation.has_recent_plan_parse(plan_file, max_age_minutes=10):
    if file.mtime_unchanged(plan_file):
        print("âš¡ QUICK RESUME: Reusing plan structure from context")
        
        # Only re-scan checkboxes (fast)
        checkboxes = quick_scan_checkboxes(plan_file)
        
        # Get cached task details from context
        tasks = conversation.get_cached_tasks(plan_file)
        
        # Merge: updated checkboxes + cached details
        plan = merge(checkboxes, tasks)
        
        print(f"âœ“ Loaded {len(tasks)} tasks in 15s (vs 3min full scan)")
        
        goto STEP_3  # Skip to "Find next uncompleted task"
```

---

## **Alternative: ThÃªm `--resume` flag**

Náº¿u muá»‘n explicit control:

```bash
# First run in conversation
/cook plan.md
# â†’ Full discovery

# Subsequent runs
/cook plan.md --resume
# â†’ Quick resume from context

# Force re-discovery
/cook plan.md --force-discovery
```

---

## **Káº¿t luáº­n:**

**Äá» xuáº¥t chÃ­nh**: ThÃªm **automatic quick resume** vÃ o Phase 1:
- Detect same conversation + unchanged file
- Reuse parsed task structure  
- Only re-scan checkbox states
- Save ~2-4 minutes per iteration

**Implementation**: ThÃªm vÃ o Ä‘áº§u Phase 1 Discovery:
```markdown
STEP 0: Quick Resume Check (NEW)
- Check conversation context
- Validate file mtime
- If valid â†’ skip to step 3 with cached data
- If invalid â†’ full discovery
```

Äiá»u nÃ y giá»¯ nguyÃªn stateless principle (váº«n cÃ³ thá»ƒ force re-read) nhÆ°ng optimize cho common case (continuous cooking in same conversation). ğŸš€

========================


TÃ´i hiá»ƒu váº¥n Ä‘á» cá»§a báº¡n. Má»—i khi cháº¡y `/cook plan.md`, há»‡ thá»‘ng pháº£i thá»±c hiá»‡n láº¡i toÃ n bá»™ quÃ¡ trÃ¬nh discovery dÃ¹ báº¡n Ä‘ang lÃ m viá»‡c trong cÃ¹ng má»™t conversation. Äiá»u nÃ y gÃ¢y lÃ£ng phÃ­ thá»i gian vÃ  tÃ i nguyÃªn, Ä‘áº·c biá»‡t vá»›i cÃ¡c káº¿ hoáº¡ch lá»›n.

DÆ°á»›i Ä‘Ã¢y lÃ  má»™t sá»‘ giáº£i phÃ¡p Ä‘á»ƒ tá»‘i Æ°u hÃ³a:

## 1. ThÃªm cÆ¡ cháº¿ caching cho discovery

```markdown
### Phase 1: Discovery (2-5 min) vá»›i cache

1. Kiá»ƒm tra cache:
   - Náº¿u lÃ  láº§n Ä‘áº§u cháº¡y trong conversation, thá»±c hiá»‡n discovery Ä‘áº§y Ä‘á»§
   - Náº¿u Ä‘Ã£ cháº¡y trÆ°á»›c Ä‘Ã³, sá»­ dá»¥ng cached plan state

2. Cache key: `plan_file_path + last_modified_time`
   - So sÃ¡nh thá»i gian sá»­a Ä‘á»•i cuá»‘i cÃ¹ng cá»§a file plan
   - Náº¿u khÃ´ng thay Ä‘á»•i, sá»­ dá»¥ng cache
   - Náº¿u cÃ³ thay Ä‘á»•i, lÃ m má»›i cache

3. Cached data:
   - Danh sÃ¡ch cÃ¡c task Ä‘Ã£ phÃ¢n tÃ­ch
   - Vá»‹ trÃ­ task hiá»‡n táº¡i
   - ThÃ´ng tin vá» subtasks
```

## 2. ThÃªm flag `--use-cache`

```bash
# Sá»­ dá»¥ng cache (máº·c Ä‘á»‹nh cho cÃ¡c láº§n cháº¡y tiáº¿p theo)
/cook plan.md --use-cache

# Buá»™c discovery láº¡i (khi cáº§n lÃ m má»›i)
/cook plan.md --force-discovery
```

## 3. Tá»‘i Æ°u hÃ³a discovery vá»›i incremental parsing

```markdown
### Phase 1: Discovery (2-5 min) - Incremental Mode

1. Äá»c file plan vÃ  xÃ¡c Ä‘á»‹nh vá»‹ trÃ­ task cuá»‘i cÃ¹ng Ä‘Ã£ hoÃ n thÃ nh:
   - TÃ¬m task cuá»‘i cÃ¹ng Ä‘Æ°á»£c Ä‘Ã¡nh dáº¥u [x]
   - Báº¯t Ä‘áº§u tÃ¬m kiáº¿m tá»« vá»‹ trÃ­ Ä‘Ã³ thay vÃ¬ tá»« Ä‘áº§u file

2. Giá»›i háº¡n pháº¡m vi tÃ¬m kiáº¿m:
   - Chá»‰ quÃ©t cÃ¡c task chÆ°a hoÃ n thÃ nh
   - Bá» qua cÃ¡c section Ä‘Ã£ hoÃ n thÃ nh

3. Vá»›i cÃ¡c file lá»›n:
   - Sá»­ dá»¥ng stream reading thay vÃ¬ load toÃ n bá»™ file
   - Chá»‰ Ä‘á»c cÃ¡c pháº§n cáº§n thiáº¿t
```

## 4. Implement stateless design vá»›i context marker

```markdown
### ThÃªm context marker vÃ o plan

- ThÃªm comment Ä‘áº·c biá»‡t vÃ o file plan:
  ```markdown
  <!-- LAST_PROCESSED: A.3.a -->
  ```

- Trong discovery:
  - TÃ¬m marker nÃ y vÃ  báº¯t Ä‘áº§u tá»« task tiáº¿p theo
  - Cáº­p nháº­t marker sau má»—i task hoÃ n thÃ nh
  - Náº¿u khÃ´ng tÃ¬m tháº¥y marker, thá»±c hiá»‡n discovery Ä‘áº§y Ä‘á»§
```

## 5. Sá»­ dá»¥ng session context trong Claude Code

```markdown
### Phase 1: Discovery (2-5 min) - Session-aware

1. Kiá»ƒm tra session context:
   - Náº¿u cÃ³ thÃ´ng tin vá» task cuá»‘i cÃ¹ng Ä‘Ã£ xá»­ lÃ½ trong session
   - Sá»­ dá»¥ng thÃ´ng tin nÃ y Ä‘á»ƒ bá» qua cÃ¡c task Ä‘Ã£ hoÃ n thÃ nh

2. Session data structure:
   ```json
   {
     "plan_file": "plan.md",
     "last_processed_task": "A.3.a",
     "completed_tasks": ["A.1", "A.2", "A.3.a"],
     "timestamp": "2023-11-15T10:30:00Z"
   }
   ```

3. Validate session data:
   - Kiá»ƒm tra xem plan file cÃ³ thay Ä‘á»•i khÃ´ng
   - XÃ¡c nháº­n cÃ¡c task Ä‘Ã£ hoÃ n thÃ nh váº«n Ä‘Æ°á»£c Ä‘Ã¡nh dáº¥u [x]
```

## Äá» xuáº¥t cá»¥ thá»ƒ

TÃ´i Ä‘á» xuáº¥t káº¿t há»£p giáº£i phÃ¡p 1 vÃ  2:

1. **ThÃªm cÆ¡ cháº¿ caching** vá»›i `--use-cache` lÃ m máº·c Ä‘á»‹nh cho cÃ¡c láº§n cháº¡y tiáº¿p theo trong cÃ¹ng má»™t conversation
2. **Sá»­ dá»¥ng incremental parsing** Ä‘á»ƒ chá»‰ Ä‘á»c cÃ¡c pháº§n cáº§n thiáº¿t cá»§a file plan
3. **ThÃªm context marker** vÃ o file plan Ä‘á»ƒ theo dÃµi tiáº¿n trÃ¬nh

CÃ¡ch triá»ƒn khai:

```markdown
### Phase 1: Discovery (2-5 min) - Optimized

1. {{ if first_run_in_session }}
   Thá»±c hiá»‡n discovery Ä‘áº§y Ä‘á»§ vÃ  lÆ°u vÃ o cache
2. {{ else if --force-discovery }}
   LÃ m má»›i cache vÃ  thá»±c hiá»‡n discovery Ä‘áº§y Ä‘á»§
3. {{ else }}
   a. Kiá»ƒm tra thá»i gian sá»­a Ä‘á»•i file plan
   b. {{ if file_changed }}
      LÃ m má»›i cache vÃ  thá»±c hiá»‡n discovery Ä‘áº§y Ä‘á»§
   c. {{ else }}
      Sá»­ dá»¥ng cached data Ä‘á»ƒ tÃ¬m task tiáº¿p theo
      Chá»‰ Ä‘á»c cÃ¡c pháº§n cáº§n thiáº¿t cá»§a file plan
   d. {{ endif }}
4. {{ endif }}
```

Vá»›i cÃ¡ch tiáº¿p cáº­n nÃ y, cÃ¡c láº§n cháº¡y tiáº¿p theo sáº½ nhanh hÆ¡n Ä‘Ã¡ng ká»ƒ vÃ¬:

- KhÃ´ng cáº§n phÃ¢n tÃ­ch láº¡i toÃ n bá»™ file plan
- KhÃ´ng cáº§n quÃ©t láº¡i cÃ¡c task Ä‘Ã£ hoÃ n thÃ nh
- Táº­p trung trá»±c tiáº¿p vÃ o task tiáº¿p theo cáº§n thá»±c hiá»‡n

========================
Váº¥n Ä‘á» báº¡n gáº·p pháº£i lÃ  sá»± xung Ä‘á»™t giá»¯a **triáº¿t lÃ½ thiáº¿t káº¿ "Stateless"** (khÃ´ng lÆ°u tráº¡ng thÃ¡i, má»—i láº§n cháº¡y lÃ  má»›i tinh) vÃ  **nhu cáº§u thá»±c táº¿ "Iterative"** (cháº¡y liÃªn tá»¥c theo chuá»—i).

Khi báº¡n cháº¡y liÃªn tá»¥c, viá»‡c AI pháº£i "Ä‘á»c láº¡i cáº£ file -\> parse markdown -\> tÃ¬m checkbox chÆ°a tick -\> validate dependency" (Phase 1) lÃ  lÃ£ng phÃ­ token vÃ  thá»i gian.

Äá»ƒ giáº£i quyáº¿t váº¥n Ä‘á» nÃ y mÃ  khÃ´ng phÃ¡ vá»¡ tÃ­nh á»•n Ä‘á»‹nh cá»§a há»‡ thá»‘ng, tÃ´i Ä‘á» xuáº¥t giáº£i phÃ¡p **"Explicit Handover" (BÃ n giao cá»¥ thá»ƒ)**.

DÆ°á»›i Ä‘Ã¢y lÃ  3 cÃ¡ch Ä‘iá»u chá»‰nh cho `/cook`, tá»« Ä‘Æ¡n giáº£n Ä‘áº¿n nÃ¢ng cao:

### Giáº£i phÃ¡p 1: ThÃªm cá» `--task=<ID>` (KhuyÃªn dÃ¹ng)

CÃ¡ch sáº¡ch nháº¥t Ä‘á»ƒ bá» qua "Discovery" lÃ  chá»‰ Ä‘á»‹nh Ä‘Ã­ch danh task cáº§n lÃ m. Báº¡n khÃ´ng cáº§n AI tá»± tÃ¬m ná»¯a, báº¡n ra lá»‡nh tháº³ng.

**1. Sá»­a pháº§n Arguments & Flags:**
ThÃªm flag `--task` vÃ o Ä‘á»‹nh nghÄ©a:

```markdown
| Flag | Description | Example |
|------|-------------|---------|
| `--task=ID` | Skip discovery, execute specific task | `--task=A.1.b` |
```

**2. Sá»­a logic Phase 1 (Discovery):**
Thay Ä‘á»•i logic Ä‘á»ƒ kiá»ƒm tra flag nÃ y trÆ°á»›c tiÃªn.

```markdown
### Phase 1: Discovery

GOAL: Find next task to execute

STEPS:

1. Read plan file: $ARGUMENTS

2. {{ if --task provided }}
   **FAST TRACK MODE:**
   - Locate specific task ID: {{ task ID }}
   - Verify it is uncompleted `[ ]`
   - Validate its dependencies are `[x]`
   - EXIT Discovery immediately with this task
   {{ else }}
   **NORMAL DISCOVERY MODE:**
   - Parse markdown...
   - Find next uncompleted...
   {{ endif }}
```

**3. Sá»­a pháº§n Output (Success Case):**
Quan trá»ng nháº¥t: Khi hoÃ n thÃ nh Task A, há»‡ thá»‘ng pháº£i **tá»± tÃ­nh toÃ¡n Task B** vÃ  Ä‘Æ°a cho báº¡n cÃ¢u lá»‡nh copy-paste.

````markdown
## Next Steps

...

**3. Continue to next task immediately:**
```bash
/cook {{ plan file }} --task={{ next_task_id }}
````

````

**Táº¡i sao cÃ¡ch nÃ y hiá»‡u quáº£?**
- Láº§n cháº¡y Ä‘áº§u: Báº¡n cháº¡y `/cook plan.md` (AI tá»‘n thá»i gian Discovery).
- Káº¿t thÃºc: AI báº£o "Xong A.1. Task tiáº¿p theo lÃ  A.2. Cháº¡y lá»‡nh nÃ y Ä‘i: `/cook plan.md --task=A.2`".
- Láº§n cháº¡y sau: Báº¡n paste lá»‡nh Ä‘Ã³. AI bá» qua bÆ°á»›c tÃ¬m kiáº¿m, nháº£y tháº³ng vÃ o lÃ m A.2.

---

### Giáº£i phÃ¡p 2: "Smart Cursor" (LÆ°u tráº¡ng thÃ¡i táº¡m)

Náº¿u báº¡n lÆ°á»i copy-paste ID, báº¡n cÃ³ thá»ƒ cho phÃ©p táº¡o má»™t file táº¡m nhá» (`.cook_cursor`) Ä‘á»ƒ nhá»› vá»‹ trÃ­. CÃ¡ch nÃ y vi pháº¡m nháº¹ nguyÃªn táº¯c "Stateless" nhÆ°ng tiá»‡n lá»£i hÆ¡n nhiá»u.

**Sá»­a Ä‘á»•i Workflow:**

1.  **Khi báº¯t Ä‘áº§u Phase 1:**
    - Kiá»ƒm tra xem cÃ³ file `.cook_cursor` khÃ´ng?
    - Náº¿u cÃ³ -> Äá»c ID tá»« Ä‘Ã³ -> Validate trong file plan xem cÃ²n `[ ]` khÃ´ng -> LÃ m luÃ´n.
    - Náº¿u khÃ´ng -> Cháº¡y Discovery bÃ¬nh thÆ°á»ng.

2.  **Khi káº¿t thÃºc (Success Case):**
    - TÃ¬m ID cá»§a task káº¿ tiáº¿p.
    - Ghi ID Ä‘Ã³ vÃ o `.cook_cursor`.

3.  **Lá»‡nh reset:**
    - Khi cháº¡y `/cook plan.md` (khÃ´ng tham sá»‘) -> Tá»± Ä‘á»™ng xÃ³a cursor Ä‘á»ƒ scan láº¡i tá»« Ä‘áº§u (Ä‘á» phÃ²ng trÆ°á»ng há»£p báº¡n muá»‘n reset).
    - Hoáº·c thÃªm lá»‡nh `/cook --resume` Ä‘á»ƒ dÃ¹ng cursor.

---

### Giáº£i phÃ¡p 3: Tá»‘i Æ°u Prompt (Context Carry-over)

Náº¿u báº¡n Ä‘ang cháº¡y trong má»™t session dÃ i cá»§a Claude Code, AI thá»±c sá»± váº«n nhá»› ngá»¯ cáº£nh cÅ©. Báº¡n cÃ³ thá»ƒ sá»­a Prompt Phase 1 Ä‘á»ƒ AI tá»± nháº­n thá»©c Ä‘iá»u nÃ y.

**Sá»­a Prompt Phase 1:**

```markdown
### Phase 1: Discovery

CONTEXT CHECK:
Did you just complete a task in the previous turn?
- If YES, and the user simply ran `/cook plan.md` again:
  1. Do NOT re-read the entire file structure deeply.
  2. Recall the "Next task" you identified in the previous turn's output.
  3. Verify quickly that line in `{{ plan file }}` is still `[ ]`.
  4. Proceed with that task immediately.
````

**NhÆ°á»£c Ä‘iá»ƒm:** CÃ¡ch nÃ y phá»¥ thuá»™c vÃ o kháº£ nÄƒng nhá»› context cá»§a LLM, Ä‘Ã´i khi nÃ³ váº«n sáº½ bá»‹ "hallucinate" hoáº·c cáº©n tháº­n quÃ¡ má»©c mÃ  Ä‘á»c láº¡i tá»« Ä‘áº§u.

-----

