# Migration Plan: Tools Pages from cong-cu to [locale]/tools

**Generated by**: /auto-plan
**Based on**: Exploration + Analysis of docs/migration/old-project/code/app/cong-cu
**Estimate**: 6-8 hours | **Risk**: Medium | **Confidence**: High

---

## Context Summary

Migrating 4 financial tools from old implementation to new Next.js 13+ structure:
- **Source**: `docs/migration/old-project/code/app/cong-cu/`
- **Target**: `src/app/[locale]/tools/`
- **Tools**: Savings calculator, Loan calculator, Gross↔Net salary calculators
- **Critical**: Vietnamese tax calculations, bank interest rate comparisons
- **Patterns**: Preserving Zustand, updating to Tailwind + shadcn/ui

---

## Phase 1: Foundation & Setup [45 minutes]

### Task 1.1: Create Type Definitions [15 min]

**File**: `src/types/tools.ts`

**Context**: Based on interfaces from old codebase (ISaving, ISalary)

**Strategy**:
1. Create TypeScript interfaces for all tool data
2. Include all fields from old interfaces
3. Add strict typing (no `any`)
4. Export types for use across components

**Acceptance Criteria**:
- [ ] ISaving interface with all fields
- [ ] ISalary interface with tax/breakdown fields
- [ ] ILoanParams and ILoanResult interfaces
- [ ] ISavingsParams and ISavingsResult interfaces
- [ ] All interfaces exported correctly

**Expected**: ✅ TypeScript compiles without errors

### Task 1.2: Update Zustand Store Types [10 min]

**File**: `src/stores/financial-tools-store.ts`

**Context**: Store already exists, needs type updates

**Strategy**:
1. Review existing store structure
2. Add missing types for savings and detailed tax calculations
3. Ensure type safety for all state
4. Maintain existing patterns

**Acceptance Criteria**:
- [ ] SavingsCalculationParams type defined
- [ ] SavingsCalculationResult type defined
- [ ] TaxCalculationDetail type expanded
- [ ] All store methods typed correctly

**Expected**: ✅ Store type errors resolved

### Task 1.3: Create Utility Constants [10 min]

**File**: `src/lib/constants/tools.ts`

**Context**: Tax brackets, insurance rates must match legal requirements

**⚠️ MUST PRESERVE**:
```typescript
// Tax brackets - Vietnamese law
export const TAX_BRACKETS = [
  { max: 5_000_000, rate: 0.05 },      // 5%
  { max: 10_000_000, rate: 0.10 },     // 10%
  { max: 18_000_000, rate: 0.15 },     // 15%
  { max: 32_000_000, rate: 0.20 },     // 20%
  { max: 52_000_000, rate: 0.25 },     // 25%
  { max: 80_000_000, rate: 0.30 },     // 30%
  { max: Infinity, rate: 0.35 },       // 35%
] as const;

// Insurance rates
export const INSURANCE_RATES = {
  employee: {
    social: 0.08,      // 8%
    health: 0.015,     // 1.5%
    unemployment: 0.01 // 1%
  },
  employer: {
    social: 0.175,     // 17.5%
    health: 0.03,      // 3%
    unemployment: 0.01 // 1%
  }
} as const;

// Allowances (2024)
export const ALLOWANCES = {
  self: 11_000_000,           // VND
  dependent: 4_400_000        // VND per person
} as const;
```

**Acceptance Criteria**:
- [ ] All constants match old system exactly
- [ ] TypeScript const assertions used
- [ ] JSDoc comments added
- [ ] Exported for use in calculators

**Expected**: ✅ Constants verified against old code

### Task 1.4: Set Up API Client Configuration [10 min]

**File**: `src/lib/api/tools.ts`

**Context**: API endpoints need to be mapped to new backend

**Strategy**:
1. Create API client functions for each tool
2. Match request/response formats exactly
3. Add proper error handling
4. Include request/response types

**Acceptance Criteria**:
- [ ] calculateSavings API function
- [ ] calculateSalary API function
- [ ] fetchInterestRates API function
- [ ] All functions properly typed
- [ ] Error handling implemented

**Expected**: ✅ API client ready for integration

---

## Phase 2: Core Business Logic [2 hours]

### Task 2.1: Test - Tax Calculation Function [15 min]

**File**: `src/lib/calculators/__tests__/tax.test.ts`

**Context**: Must preserve exact tax calculation algorithm

**Strategy**:
1. Write tests with known inputs/outputs from old system
2. Test all 7 tax brackets
3. Test edge cases (0, bracket boundaries)
4. Run tests → Should fail initially

**Test Cases**:
```typescript
// Test case 1: Income in first bracket
calculateTax(4_000_000) // Should be 200,000 (5%)

// Test case 2: Income across multiple brackets
calculateTax(12_000_000) // Should be 795,000
// = 5M×5% + 5M×10% + 2M×15%

// Test case 3: High income (all brackets)
calculateTax(100_000_000) // Should calculate all brackets
```

**Acceptance Criteria**:
- [ ] Test file created
- [ ] At least 10 test cases
- [ ] All brackets tested
- [ ] Tests fail (no implementation yet)

**Expected**: ❌ Tests fail (expected)

### Task 2.2: Implement - Tax Calculation Function [30 min]

**File**: `src/lib/calculators/tax.ts`

**Context**: Algorithm from old salary calculation logic

**⚠️ MUST PRESERVE**:
- Progressive calculation method
- Exact bracket rates
- Rounding behavior

**Strategy**:
1. Study old tax calculation algorithm
2. Implement progressive tax calculation
3. Handle all edge cases
4. Make it a pure function

**Implementation**:
```typescript
export function calculateTax(taxableIncome: number): number {
  let tax = 0;
  let remainingIncome = taxableIncome;

  for (const bracket of TAX_BRACKETS) {
    if (remainingIncome <= 0) break;

    const taxableInBracket = Math.min(
      remainingIncome,
      bracket.max - (TAX_BRACKETS[TAX_BRACKETS.indexOf(bracket) - 1]?.max ?? 0)
    );

    tax += taxableInBracket * bracket.rate;
    remainingIncome -= taxableInBracket;
  }

  return Math.round(tax);
}
```

**Acceptance Criteria**:
- [ ] Function implemented correctly
- [ ] All tests pass
- [ ] Handles edge cases
- [ ] Pure function (no side effects)

**Expected**: ✅ All tests pass

### Task 2.3: Test - Insurance Calculation [10 min]

**File**: `src/lib/calculators/__tests__/insurance.test.ts`

**Strategy**:
1. Write tests for employee insurance
2. Write tests for employer insurance
3. Test rate combinations
4. Verify against old system

**Acceptance Criteria**:
- [ ] Insurance calculation tests
- [ ] Employee rates tested
- [ ] Employer rates tested
- [ ] Combined calculations tested

**Expected**: ❌ Tests fail (no implementation)

### Task 2.4: Implement - Insurance Calculation [20 min]

**File**: `src/lib/calculators/insurance.ts`

**Context**: Insurance rate calculations must match legal requirements

**Strategy**:
1. Implement employee insurance calculation
2. Implement employer insurance calculation
3. Add salary cap validation
4. Return breakdown object

**Acceptance Criteria**:
- [ ] Employee insurance calculation
- [ ] Employer insurance calculation
- [ ] Salary cap handling
- [ ] All tests pass

**Expected**: ✅ Insurance calculations correct

### Task 2.5: Test - Salary Gross to Net Conversion [15 min]

**File**: `src/lib/calculators/__tests__/salary-gross-to-net.test.ts`

**Strategy**:
1. Create test cases with known gross salaries
2. Include different regions and dependents
3. Test against old system outputs
4. Verify all deduction components

**Acceptance Criteria**:
- [ ] 10+ test scenarios
- [ ] Different regions tested
- [ ] Different dependent counts
- [ ] All deduction components verified

**Expected**: ❌ Tests fail

### Task 2.6: Implement - Salary Gross to Net [30 min]

**File**: `src/lib/calculators/salary-gross-to-net.ts`

**Context**: Complete salary conversion with all deductions

**Strategy**:
1. Combine tax and insurance calculations
2. Add allowance deductions
3. Apply regional minimums
4. Return complete breakdown

**Acceptance Criteria**:
- [ ] Complete gross to net calculation
- [ ] All deduction types included
- [ ] Regional variations handled
- [ ] Tests pass with exact matches

**Expected**: ✅ Calculations match old system

### Task 2.7: Test - Salary Net to Gross [10 min]

**File**: `src/lib/calculators/__tests__/salary-net-to-gross.test.ts`

**Strategy**:
1. Test reverse calculation algorithm
2. Verify with iterative approach
3. Test edge cases (minimum wage)

**Acceptance Criteria**:
- [ ] Reverse calculation tests
- [ ] Iterative algorithm verification
- [ ] Edge case handling

**Expected**: ❌ Tests fail

### Task 2.8: Implement - Salary Net to Gross [20 min]

**File**: `src/lib/calculators/salary-net-to-gross.ts`

**Context**: Reverse calculation requires iterative approach

**Strategy**:
1. Implement iterative gross calculation
2. Start with gross = net
3. Increment until net matches target
4. Add convergence check

**Acceptance Criteria**:
- [ ] Iterative calculation implemented
- [ ] Convergence logic added
- [ ] Performance optimized
- [ ] Tests pass

**Expected**: ✅ Reverse calculations work

---

## Phase 3: UI Components [1.5 hours]

### Task 3.1: Create Savings Calculator Component [30 min]

**File**: `src/components/tools/SavingsCalculator.tsx`

**Context**: Replace old SavingTool with modern component

**Strategy**:
1. Use shadcn/ui components (Card, Input, Select, Button)
2. Implement filter controls (amount, period, type, sort)
3. Create results table with pagination
4. Add min/max rate highlighting

**Key Features**:
- Amount slider: 10-1000M VND
- Period dropdown: 1,3,6,9,12,18,24 months
- Type toggle: Counter/Online
- Sort options: Rate asc/desc
- Results table with bank comparisons

**Acceptance Criteria**:
- [ ] All filter controls implemented
- [ ] Bank comparison table
- [ ] Min/max rate highlighting
- [ ] Pagination for results
- [ ] External links to banks

**Expected**: ✅ Component renders and filters work

### Task 3.2: Create Loan Calculator Component [30 min]

**File**: `src/components/tools/LoanCalculator.tsx`

**Context**: Migrate loan calculation features

**Strategy**:
1. Create loan input form (amount, term, rate)
2. Calculate monthly payments
3. Generate amortization schedule
4. Show total interest paid

**Acceptance Criteria**:
- [ ] Loan input form
- [ ] Monthly payment calculation
- [ ] Amortization schedule table
- [ ] Total interest display

**Expected**: ✅ Loan calculations accurate

### Task 3.3: Create Gross to Net Salary Calculator [15 min]

**File**: `src/components/tools/GrossToNetCalculator.tsx`

**Context**: Salary conversion with Vietnamese specifics

**Strategy**:
1. Salary input with validation
2. Region selection (4 zones)
3. Dependent count input
4. Detailed breakdown display

**Acceptance Criteria**:
- [ ] Salary input with proper validation
- [ ] Region dropdown
- [ ] Dependent counter
- [ ] Complete deduction breakdown

**Expected**: ✅ All deductions shown correctly

### Task 3.4: Create Net to Gross Salary Calculator [15 min]

**File**: `src/components/tools/NetToGrossCalculator.tsx`

**Context**: Reverse salary calculation

**Strategy**:
1. Similar to Gross to Net but reversed
2. Show gross estimate
3. Display calculation notes
4. Add optimization suggestions

**Acceptance Criteria**:
- [ ] Net salary input
- [ ] Gross salary estimate
- [ ] Calculation transparency
- [ ] Tax optimization tips

**Expected**: ✅ Reverse calculation works

---

## Phase 4: Page Integration [1 hour]

### Task 4.1: Create Savings Calculator Page [15 min]

**File**: `src/app/[locale]/tools/savings-calculator/page.tsx`

**Context**: Replace old tinh-lai-tien-gui page

**Strategy**:
1. Create Next.js page component
2. Add page metadata (SEO)
3. Include breadcrumbs
4. Integrate SavingsCalculator component

**Acceptance Criteria**:
- [ ] Page renders correctly
- [ ] SEO metadata added
- [ ] Breadcrumbs working
- [ ] Component integrated

**Expected**: ✅ Page accessible at /tools/savings-calculator

### Task 4.2: Create Loan Calculator Page [15 min]

**File**: `src/app/[locale]/tools/loan-calculator/page.tsx`

**Context**: Replace old tinh-toan-khoan-vay page

**Strategy**:
1. Similar structure to savings page
2. Loan-specific metadata
3. Integrate LoanCalculator component

**Acceptance Criteria**:
- [ ] Page created
- [ ] Component integrated
- [ ] Route working

**Expected**: ✅ Page accessible at /tools/loan-calculator

### Task 4.3: Create Gross to Net Page [15 min]

**File**: `src/app/[locale]/tools/gross-to-net-calculator/page.tsx`

**Context**: Replace old tinh-luong-gross-net page

**Strategy**:
1. Create page with Vietnamese title
2. Add calculator integration
3. Include helpful descriptions

**Acceptance Criteria**:
- [ ] Page created with proper naming
- [ ] Calculator integrated
- [ ] Vietnamese content

**Expected**: ✅ Page accessible at /tools/gross-to-net-calculator

### Task 4.4: Create Net to Gross Page [15 min]

**File**: `src/app/[locale]/tools/net-to-gross-calculator/page.tsx`

**Context**: Replace old tinh-luong-net-gross page

**Strategy**:
1. Mirror gross to net page structure
2. Adjust for reverse calculation
3. Add specific guidance

**Acceptance Criteria**:
- [ ] Page created
- [ ] Reverse calculator integrated
- [ ] Clear instructions

**Expected**: ✅ Page accessible at /tools/net-to-gross-calculator

---

## Phase 5: API Integration & State Management [1 hour]

### Task 5.1: Connect Savings Calculator to API [20 min]

**File**: `src/components/tools/SavingsCalculator.tsx` (update)

**Context**: Connect to backend savings calculation API

**Strategy**:
1. Use store action for savings calculations
2. Handle loading states
3. Display errors gracefully
4. Cache results

**Acceptance Criteria**:
- [ ] API calls working
- [ ] Loading states shown
- [ ] Errors handled
- [ ] Results cached

**Expected**: ✅ Real bank data displayed

### Task 5.2: Implement User Tracking [20 min]

**File**: `src/lib/tracking/tools.ts`

**Context**: Preserve existing user tracking requirements

**Strategy**:
1. Create tracking events for all interactions
2. Track filter changes, calculations
3. Send to analytics endpoint
4. Respect privacy settings

**Acceptance Criteria**:
- [ ] Filter change events
- [ ] Calculation events
- [ ] Page view events
- [ ] Privacy compliance

**Expected**: ✅ All interactions tracked

### Task 5.3: Add Error Boundaries [20 min]

**File**: `src/components/tools/ErrorBoundary.tsx`

**Context**: Handle calculation errors gracefully

**Strategy**:
1. Create error boundary component
2. Wrap all calculator components
3. Log errors appropriately
4. Show user-friendly messages

**Acceptance Criteria**:
- [ ] Error boundary created
- [ ] Components wrapped
- [ ] Errors logged
- [ ] Friendly messages shown

**Expected**: ✅ Graceful error handling

---

## Phase 6: Testing & Verification [1 hour]

### Task 6.1: Unit Test All Calculators [30 min]

**Files**: Multiple test files

**Strategy**:
1. Review all calculator tests
2. Add edge case coverage
3. Verify against old system
4. Achieve 80%+ coverage

**Acceptance Criteria**:
- [ ] All calculators tested
- [ ] Edge cases covered
- [ ] 80%+ coverage achieved
- [ ] Results match old system

**Expected**: ✅ Comprehensive test suite

### Task 6.2: Integration Tests [20 min]

**Files**: `src/e2e/tools.spec.ts`

**Strategy**:
1. Test complete user flows
2. Verify page navigation
3. Check form submissions
4. Validate result displays

**Acceptance Criteria**:
- [ ] All tools tested end-to-end
- [ ] Navigation works
- [ ] Forms submit correctly
- [ ] Results accurate

**Expected**: ✅ Full integration testing

### Task 6.3: Cross-Browser Testing [10 min]

**Strategy**:
1. Test in Chrome, Firefox, Safari
2. Check mobile responsiveness
3. Verify calculations work
4. Validate UI consistency

**Acceptance Criteria**:
- [ ] All browsers work
- [ ] Mobile responsive
- [ ] Calculations consistent
- [ ] UI consistent

**Expected**: ✅ Cross-browser compatibility

---

## Phase 7: Polish & Documentation [45 minutes]

### Task 7.1: Add Accessibility [15 min]

**Files**: Multiple component files

**Strategy**:
1. Add ARIA labels to all inputs
2. Ensure keyboard navigation
3. Add screen reader support
4. Test with accessibility tools

**Acceptance Criteria**:
- [ ] ARIA labels added
- [ ] Keyboard navigation works
- [ ] Screen reader friendly
- [ ] WCAG 2.1 AA compliant

**Expected**: ✅ Accessible to all users

### Task 7.2: Performance Optimization [15 min]

**Strategy**:
1. Memoize expensive calculations
2. Lazy load heavy components
3. Optimize bundle size
4. Add loading skeletons

**Acceptance Criteria**:
- [ ] Calculations memoized
- [ ] Components lazy loaded
- [ ] Bundle optimized
- [ ] Loading states smooth

**Expected**: ✅ Fast, responsive UI

### Task 7.3: Documentation [10 min]

**File**: `docs/tools-migration-guide.md`

**Strategy**:
1. Document migration process
2. Create developer guide
3. Add API documentation
4. Include testing instructions

**Acceptance Criteria**:
- [ ] Migration guide created
- [ ] API documented
- [ ] Testing guide added
- [ ] Code comments complete

**Expected**: ✅ Clear documentation

### Task 7.4: Final Verification [5 min]

**Strategy**:
1. Run full test suite
2. Verify all calculations
3. Check all routes
4. Confirm no regressions

**Acceptance Criteria**:
- [ ] All tests pass
- [ ] Calculations verified
- [ ] Routes working
- [ ] No regressions

**Expected**: ✅ Ready for production

---

## Preservation Checklist

Before executing this plan:
- [ ] Understand Vietnamese tax calculation algorithm
- [ ] Note exact insurance rate percentages
- [ ] Verify allowance amounts for 2024
- [ ] Review bank interest rate API structure
- [ ] Check all filter options from old system

### Critical Sections to Preserve:
- ✅ Tax bracket values and progressive calculation
- ✅ Insurance rates (employee + employer)
- ✅ Allowance amounts (legal requirements)
- ✅ Bank interest rate comparison logic
- ✅ API request/response formats
- ✅ User tracking requirements

---

## Execution Instructions

1. **Save this plan**: Already saved to `plans/tools-migration.md`

2. **Execute with subagents**:
   ```bash
   /execute-plan plans/tools-migration.md
   ```

3. **During execution**:
   - Reference old code frequently
   - Test calculations against old system
   - Verify PRESERVE sections carefully
   - Commit after each phase

4. **After execution**:
   - Run full test suite
   - Verify calculations match old system
   - Test all user flows
   - Check performance metrics

---

## Verification Strategy

### Critical Items:
1. Tax calculations (must match 100%)
2. Insurance deductions (exact percentages)
3. Bank interest rate comparisons
4. API compatibility
5. User tracking integrity

### Verification Method:
- Create test suite with 20+ scenarios
- Compare outputs with old system
- Test edge cases (min/max values)
- Verify rounding behavior
- Check UI responsiveness

### Success Metrics:
- All calculations match old system
- No functional regressions
- Improved performance
- Better accessibility
- Maintained SEO rankings

---

## Risk Mitigation

### High-Risk Items:
1. **Tax calculation accuracy**
   - Mitigation: Extensive testing against old system
   - Verification: 100% output matching

2. **API compatibility**
   - Mitigation: Preserve request/response formats
   - Verification: Integration tests

3. **User experience disruption**
   - Mitigation: Maintain similar UI patterns
   - Verification: User acceptance testing

### Rollback Plan:
- Keep old implementation available
- Feature flag for new implementation
- Gradual rollout with monitoring
- Quick rollback if issues arise

---

**Plan ready for execution!** ✅

Remember: The Vietnamese tax calculations must be exact - these are legal requirements, not approximations. Test thoroughly before production deployment.